{% extends 'base.html' %}
{% block content %}
<h1>Return Visitor</h1>

<style>
/* Loading overlay style */
#loading-overlay {
    display: none; /* Hidden until submit */
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.7);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 6px solid #ccc;
    border-top-color: #007bff;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<!-- Spinner overlay -->
<div id="loading-overlay">
    <div class="spinner"></div>
</div>

<form method="post">
    {% csrf_token %}
    <div class="form-group mb-4">
        <label for="company_name">Company:</label>
        <select class="form-control" id="company_name" name="company_name" required>
            <option value="" disabled selected>Select Company</option>
            {% for company in companies %}
                <option value="{{ company }}">{{ company }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group mb-4">
        <label for="visitor_name">Visitor:</label>
        <select class="form-control" id="visitor_name" name="visitor_name" required>
            <option value="" disabled selected>Select Visitor</option>
        </select>
    </div>
    <div class="form-group mb-4">
        <label for="phone_number">Phone Number:</label>
        <input type="text" class="form-control" id="phone_number" name="phone_number" readonly>
    </div>
    <div class="form-group mb-4">
        <label for="visit_to">Visit to:</label>
        <select class="form-control" id="visit_to" name="visit_to" required>
            <option value="" disabled selected>Select who you are visiting</option>
            {% for value, label in visit_to_choices %}
                <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Health Declaration Section -->
    <fieldset style="border:1px solid #b3b3b3; padding:1em; margin-bottom:1.5em;">
        <legend><b>Health Declaration</b></legend>
        <div class="form-group mb-3">
            <label class="switch-label" for="id_has_no_fever">
              <input type="checkbox" name="has_no_fever" id="id_has_no_fever">
              <span class="switch-custom"></span>
              <span class="switch-text">I Have No Fever</span>
              <div class="switch-confirm">Touch to Confirm</div>
            </label>
        </div>
        <div class="form-group mb-3">
            <label class="switch-label" for="id_has_no_vomiting">
                <input type="checkbox" name="has_no_vomiting" id="id_has_no_vomiting">
                <span class="switch-custom"></span>
                <span class="switch-text">I Have No Vomiting</span>
                <div class="switch-confirm">Touch to Confirm</div>
            </label>
        </div>
        <div class="form-group mb-3">
            <label class="switch-label" for="id_has_no_skin_lesions">
                <input type="checkbox" name="has_no_skin_lesions" id="id_has_no_skin_lesions">
                <span class="switch-custom"></span>
                <span class="switch-text">I Have No Skin Lesions</span>
                <div class="switch-confirm">Touch to Confirm</div>
            </label>
        </div>
        <div class="form-group mb-3">
            <label class="switch-label" for="id_has_no_running_nose">
                <input type="checkbox" name="has_no_running_nose" id="id_has_no_running_nose">
                <span class="switch-custom"></span>
                <span class="switch-text">I Have No Running Nose or Ear Discharge</span>
                <div class="switch-confirm">Touch to Confirm</div>
            </label>
        </div>
    </fieldset>

    <button class="btn btn-secondary" type="submit">Submit</button>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
</form>

{{ visitors_by_company|json_script:"visitors-data" }}

<script>
/* Populate visitors when company changes */
const visitorsByCompany = JSON.parse(document.getElementById('visitors-data').textContent);
document.getElementById('company_name').addEventListener('change', function() {
    const company = this.value;
    const visitorSelect = document.getElementById('visitor_name');
    const phoneInput = document.getElementById('phone_number');
    visitorSelect.innerHTML = '<option value="" disabled selected>Select Visitor</option>';
    phoneInput.value = '';
    if (visitorsByCompany[company]) {
        visitorsByCompany[company].forEach(function(visitor) {
            const option = document.createElement('option');
            option.value = visitor[0];
            option.textContent = visitor[0];
            visitorSelect.appendChild(option);
        });
    }
});

/* Populate phone when visitor changes */
document.getElementById('visitor_name').addEventListener('change', function() {
    const company = document.getElementById('company_name').value;
    const visitorName = this.value;
    const visitorData = visitorsByCompany[company].find(v => v[0] === visitorName);
    document.getElementById('phone_number').value = visitorData ? visitorData[1] : '';
});

/* Validation + Spinner on submit */
document.querySelector('form').addEventListener('submit', function(e) {
    var ids = [
        'id_has_no_fever',
        'id_has_no_vomiting',
        'id_has_no_skin_lesions',
        'id_has_no_running_nose'
    ];
    var valid = true;
    ids.forEach(function(id) {
        var checkbox = document.getElementById(id);
        var confirmDiv = checkbox.closest('.form-group').querySelector('.switch-confirm');
        if (!checkbox.checked) {
            confirmDiv.textContent = 'Please confirm';
            confirmDiv.style.color = 'red';
            confirmDiv.style.display = 'inline';
            valid = false;
        } else {
            confirmDiv.style.display = 'none';
        }
    });

    if (!valid) {
        e.preventDefault();
    } else {
        document.getElementById('loading-overlay').style.display = 'flex';
    }
});

/* Live update confirm text */
['id_has_no_fever','id_has_no_vomiting','id_has_no_skin_lesions','id_has_no_running_nose'].forEach(function(id) {
    var checkbox = document.getElementById(id);
    var confirmDiv = checkbox.closest('.form-group').querySelector('.switch-confirm');
    checkbox.addEventListener('change', function() {
        if (checkbox.checked) {
            confirmDiv.style.display = 'none';
        } else {
            confirmDiv.textContent = 'Touch to Confirm';
            confirmDiv.style.color = '';
            confirmDiv.style.display = 'inline';
        }
    });
});
</script>
{% endblock %}
